{% load static %}
<!DOCTYPE html>
<html lang="en" class="transition-colors duration-500">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Adopt Me{% endblock %}</title>
  <link rel="icon" href="{% static 'img/favicon.ico' %}">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            background: "#f8fafc",
            surface: "#ffffff",
            border: "#e2e8f0",
            text: "#0f172a",
            accent: "#3b82f6",
            darkbg: "#0d1117",
            darksurface: "#161b22",
            darkborder: "#30363d",
            darktext: "#e6edf3",
          }
        }
      }
    }
  </script>

  <!-- Prevent Flash -->
  <script>
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    }
  </script>
</head>

<body class="bg-background dark:bg-darkbg text-text dark:text-darktext min-h-screen flex flex-col">

<!-- Toast Container -->
<div id="toast-container" class="fixed bottom-5 right-5 space-y-3 z-50 pointer-events-none"></div>

<!-- Header -->
<header class="bg-surface dark:bg-darksurface border-b border-border dark:border-darkborder p-4 md:px-10 shadow-sm">
  <nav class="flex justify-between items-center">

    <a href="{% url 'home' %}" class="text-xl font-bold text-accent">Adopt Me</a>

    <!-- Desktop Nav -->
    <div class="hidden md:flex items-center space-x-6">
      <a href="{% url 'home' %}" class="hover:text-accent">Home</a>
      <a href="{% url 'about' %}" class="hover:text-accent">About</a>
      <a href="{% url 'posts' %}" class="hover:text-accent">Posts</a>

      {% if user.is_authenticated %}
        {% if user.shelter_profile %}
          <a href="{% url 'shelter_profile' %}" class="hover:text-accent">Shelter Profile</a>
        {% else %}
          <a href="{% url 'shelter_register' %}" class="hover:text-accent">Become a Shelter</a>
        {% endif %}

        {% if user.is_superuser %}
          <a href="{% url 'dashboard_home' %}" class="hover:text-accent font-semibold">Dashboard</a>
        {% endif %}

        <a href="{% url 'profile' %}" class="hover:text-accent">Profile</a>
        <a href="{% url 'logout' %}" class="hover:text-red-500">Logout</a>

      {% else %}
        <a href="{% url 'login' %}" class="hover:text-accent">Login</a>
      {% endif %}

      <!-- Theme -->
      <button id="theme-toggle" class="w-10 h-10 rounded-full overflow-hidden">
        <img id="theme-icon" src="{% static 'img/sun.png' %}">
      </button>

    </div>

    <!-- Mobile -->
    <div class="md:hidden flex items-center space-x-2">
      <button id="mobile-menu-toggle" class="text-xl px-3 py-1">☰</button>

      <button id="theme-toggle-mobile" class="w-10 h-10 rounded-full overflow-hidden">
        <img id="theme-icon-mobile" src="{% static 'img/sun.png' %}">
      </button>
    </div>

  </nav>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="hidden md:hidden mt-3 bg-surface dark:bg-darksurface border dark:border-darkborder rounded-lg p-4 space-y-2">

    <a href="{% url 'home' %}" class="block hover:text-accent">Home</a>
    <a href="{% url 'about' %}" class="block hover:text-accent">About</a>
    <a href="{% url 'posts' %}" class="block hover:text-accent">Posts</a>

    {% if user.is_superuser %}
      <a href="{% url 'dashboard_home' %}" class="block text-accent">Dashboard</a>
    {% endif %}

    {% if user.is_authenticated %}
      <a href="{% url 'profile' %}" class="block hover:text-accent">Profile</a>
      <a href="{% url 'logout' %}" class="block hover:text-red-500">Logout</a>
    {% else %}
      <a href="{% url 'login' %}" class="block hover:text-accent">Login</a>
    {% endif %}
  </div>

</header>

<!-- Main -->
<main class="flex-grow">
  {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="text-center text-sm text-gray-500 dark:text-gray-400 border-t dark:border-darkborder py-6">
  &copy; {% now "Y" %} Adopt Me | Made by ผู้ดีBangkok
</footer>

<!-- Django Messages → JS Safe Encoding -->
{% if messages %}
<script>
window.DjangoMessages = JSON.parse(`[
  {% for msg in messages %}
    {"level":"{{ msg.tags|escapejs }}","text":"{{ msg|escapejs }}"}{% if not forloop.last %},{% endif %}
  {% endfor %}
]`);
</script>
{% endif %}

<!-- Toast System (Protected with VERBATIM) -->
{% verbatim %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!window.DjangoMessages) return;

  const container = document.getElementById("toast-container");

  window.DjangoMessages.forEach(msg => createToast(msg.text, msg.level));

  function createToast(text, level) {
    const t = document.createElement("div");

    t.className = `
      pointer-events-auto flex items-start gap-3 p-4 w-80 rounded-xl shadow-xl
      border text-sm font-medium cursor-pointer bg-opacity-90
      transform translate-y-5 opacity-0 transition-all duration-500
      ${color(level)}
    `;

    t.innerHTML = `
      <div class="pt-1">${icon(level)}</div>
      <div>${text}</div>
    `;

    container.appendChild(t);

    setTimeout(() => {
      t.classList.remove("translate-y-5", "opacity-0");
      t.classList.add("translate-y-0", "opacity-100");
    }, 20);

    const timer = setTimeout(() => dismiss(t), 4000);
    t.onclick = () => { clearTimeout(timer); dismiss(t); };
  }

  function dismiss(t) {
    t.classList.add("translate-y-5", "opacity-0");
    setTimeout(() => t.remove(), 500);
  }

  function color(level) {
    return {
      error: "bg-red-600 text-white border-red-700",
      success: "bg-green-600 text-white border-green-700",
      info: "bg-blue-600 text-white border-blue-700"
    }[level] || "bg-blue-600 text-white border-blue-700";
  }

  function icon(level) {
    return { error: "❌", success: "✔️", info: "ℹ️" }[level] || "ℹ️";
  }
});
</script>
{% endverbatim %}

<!-- Theme Toggle -->
<script>
const html = document.documentElement;
const themeBtn = document.getElementById("theme-toggle");
const themeBtnMobile = document.getElementById("theme-toggle-mobile");
const iconDesktop = document.getElementById("theme-icon");
const iconMobile = document.getElementById("theme-icon-mobile");
const sun = "{% static 'img/sun.png' %}";
const moon = "{% static 'img/moon.png' %}";

function updateIcons() {
  const dark = html.classList.contains("dark");
  iconDesktop.src = dark ? moon : sun;
  iconMobile.src = dark ? moon : sun;
}

function toggleTheme() {
  html.classList.toggle("dark");
  localStorage.setItem("theme", html.classList.contains("dark") ? "dark" : "light");
  updateIcons();
}

themeBtn.onclick = toggleTheme;
themeBtnMobile.onclick = toggleTheme;
updateIcons();
</script>

<!-- Mobile Menu -->
<script>
document.getElementById("mobile-menu-toggle").onclick = () => {
  document.getElementById("mobile-menu").classList.toggle("hidden");
};
</script>

</body>
</html>
